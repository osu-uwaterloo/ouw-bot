<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>osu!uw Membership Management</title>
	<link rel="stylesheet" href="../static/css/style.css">
	<script src="../static/js/triangles.js"></script>
</head>
<body>
	<svg id="background" viewBox="0 0 192 168"></svg>
    <div class="app">
		<script>
			const token = '{{ token }}';
		</script>
		<div id="welcome-message" class="card hide">
			<div class="card-body row">
				<svg class="big-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 48a208 208 0 1 1 0 416 208 208 0 1 1 0-416zm0 464A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-111 111-47-47c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l64 64c9.4 9.4 24.6 9.4 33.9 0L369 209z"/></svg>
				<div>
					<h1 style="margin-top: 0.4em;">You have been verified!</h1>
					<p>Welcome to osu!uwaterloo! You have been given the verified roles on the Discord server.</p>
				</div>
			</div>
			<script>
				if (new URLSearchParams(window.location.search).has('verified')) {
					document.getElementById('welcome-message').classList.remove('hide');
				}
			</script>
		</div>
		<div id="info" class="card">
			<div class="card-title">Manage Membership</div>
			<div class="card-body">
				<p>You can manage your membership below.</p>
				<p>Managing membership for <code>@{{discordUsername}}</code> (<code>{{discordId}}</code>)</p>
				<p>WatIAM: <code>{{watiam}}</code></p>
				<p class="note">Use the <code>/manage_membership</code> command in the Discord server to access this page later.</p>
				<p class="note">If you want to change WatIAM or remove your membership, please contact an executive.</p>
			</div>
		</div>

		<div id="osu-account" class="card">
			<div class="card-title">osu! Account</div>
			<div class="card-body">
				<p class="linked-osu-account"></p>
			</div>
			<div class="card-actions">
				<button class="button danger" id="unlink-osu-account" onclick="unlinkOsuAccount()">Unlink osu! Account</button>
				<a href="{{ membershipManagementBaseUrl }}/link-osu-account" class="button" id="link-osu-account">Link osu! Account</a>
			</div>			
			<script>
				let osuAccount = '{{ osuAccount }}';
				const updateOsuAccountDisplay = () => {
					if (osuAccount) {
						document.querySelector('.linked-osu-account').innerHTML = `You have an <a href="https://osu.ppy.sh/users/${osuAccount}" target="_blank">osu! account</a> (uid: <code>${osuAccount}</code>) linked.`;
						document.querySelector('#unlink-osu-account').classList.remove('hide');
						document.querySelector('#link-osu-account').classList.add('hide');
					} else {
						document.querySelector('.linked-osu-account').innerHTML = `You do not have an osu! account linked yet. Link your osu! account here!`;
						document.querySelector('#unlink-osu-account').classList.add('hide');
						document.querySelector('#link-osu-account').classList.remove('hide');
					}
				};
				updateOsuAccountDisplay();
				async function unlinkOsuAccount() {
					if (confirm('Are you sure you want to unlink your osu! account?')) {
						document.querySelector('#unlink-osu-account').disabled = true;
						document.querySelector('#unlink-osu-account').classList.add('loading');
						try {
							const response = await fetch('{{ membershipManagementBaseUrl }}/unlink-osu-account', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json',
								},
								body: JSON.stringify({ token }),
							});
							const json = await response.json();
							if (json.status === 'success') {
								osuAccount = '';
								updateOsuAccountDisplay();
							} else {
								alert(json.message);
							}
						} catch (error) {
							console.error(error);
							alert(`An error occurred. Please try again later. Error: ${error}`);
						}
						document.querySelector('#unlink-osu-account').disabled = false;
						document.querySelector('#unlink-osu-account').classList.remove('loading');
					}
				}
			</script>
		</div>
		<div id="display-on-website" class="card">
			<div class="card-title">Website Display</div>
			<div class="card-body">
				<p class="linked-website">You can choose whether to display your profile on the club website's <a href="https://osu.uwaterloo.ca/members" target="_blank">member</a> page.</p>
				<div class="switch">
					<input type="checkbox" id="display-on-website-switch">
					<label for="display-on-website-switch"></label>
					<label for="display-on-website-switch">Display my profile on club website</label>
				</div>
			</div>
			<div class="card-actions">
				<button class="button" disabled id="update-display-on-website" onclick="submitDisplayOnWebsite()">Update</button>
			</div>
			<script>
				let displayOnWebsite = '{{ displayOnWebsite }}' === 'true';
				document.querySelector('#display-on-website-switch').checked = displayOnWebsite;
				
				let displayOnWebsiteNew = displayOnWebsite;
				document.querySelector('#display-on-website-switch').addEventListener('change', () => {
					displayOnWebsiteNew = document.querySelector('#display-on-website-switch').checked;
					updateDisplayOnWebsite();
				});
				const updateDisplayOnWebsite = () => {
					document.querySelector('#update-display-on-website').disabled = displayOnWebsite === displayOnWebsiteNew;
				};
				
				async function submitDisplayOnWebsite() {
					document.querySelector('#update-display-on-website').disabled = true;
					document.querySelector('#update-display-on-website').classList.add('loading');
					try {
						const response = await fetch('{{ membershipManagementBaseUrl }}/update-display-on-website', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({ token, displayOnWebsite: displayOnWebsiteNew }),
						});
						const json = await response.json();
						if (json.status === 'success') {
							displayOnWebsite = displayOnWebsiteNew;
							updateDisplayOnWebsite();
						} else {
							alert(json.message);
						}
					} catch (error) {
						console.error(error);
						alert(`An error occurred. Please try again later. Error: ${error}`);
					}
					document.querySelector('#update-display-on-website').disabled = false;
					document.querySelector('#update-display-on-website').classList.remove('loading');
				}
			</script>
		</div>
    </div>
</body>
</html>